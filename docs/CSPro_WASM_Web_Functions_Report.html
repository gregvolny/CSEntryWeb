<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSPro WASM/Web Logic & API Implementation Report</title>
    <style>
        @media print {
            body { font-size: 11pt; }
            .page-break { page-break-before: always; }
            table { page-break-inside: avoid; }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        
        h1 {
            color: #1a5276;
            border-bottom: 3px solid #1a5276;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #2874a6;
            border-bottom: 2px solid #aed6f1;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        
        h3 {
            color: #3498db;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9em;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #2874a6;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e8f4f8;
        }
        
        .status-implemented { color: #27ae60; font-weight: bold; }
        .status-stub { color: #f39c12; font-weight: bold; }
        .status-partial { color: #e67e22; font-weight: bold; }
        .status-unavailable { color: #e74c3c; font-weight: bold; }
        
        .priority-high { background-color: #fadbd8 !important; }
        .priority-medium { background-color: #fdebd0 !important; }
        .priority-low { background-color: #d5f5e3 !important; }
        
        .code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        
        .web-api {
            background-color: #d4edda;
            padding: 10px;
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        
        .note {
            background-color: #fff3cd;
            padding: 10px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }
        
        .warning {
            background-color: #f8d7da;
            padding: 10px;
            border-left: 4px solid #dc3545;
            margin: 10px 0;
        }
        
        .summary-box {
            background-color: #e8f4f8;
            border: 2px solid #2874a6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .toc {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .toc a {
            color: #2874a6;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        .header-info {
            display: flex;
            justify-content: space-between;
            color: #666;
            margin-bottom: 20px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .api-namespace {
            background-color: #eaf2f8;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            color: #2874a6;
        }
    </style>
</head>
<body>
    <div class="header-info">
        <span>CSPro Web Application Project</span>
        <span>Generated: November 29, 2025</span>
    </div>
    
    <h1>ðŸ“‹ CSPro WASM/Web Logic & API Implementation Report</h1>
    
    <div class="summary-box">
        <h3 style="margin-top: 0;">Executive Summary</h3>
        <p>This comprehensive report documents the implementation status of the entire CSPro logic function library, the Action Invoker API, and file system architectures for the WASM/Web environment.</p>
        <p><strong>Scope:</strong></p>
        <ul>
            <li><strong>Logic Functions:</strong> 300+ standard CSPro functions analyzed.</li>
            <li><strong>Action Invoker:</strong> 15 Namespaces and their methods documented.</li>
            <li><strong>File System:</strong> Analysis of WASM Virtual FS, OPFS, and Server-side FS options.</li>
        </ul>
    </div>
    
    <div class="toc">
        <h3 style="margin-top: 0;">Table of Contents</h3>
        <ol>
            <li><a href="#filesystem-arch">File System Architecture & Alternatives</a></li>
            <li><a href="#action-invoker">Action Invoker API Reference</a></li>
            <li><a href="#logic-functions">Complete CSPro Logic Function Reference</a></li>
            <li><a href="#os-specific">OS-Specific Function Deep Dive</a></li>
            <li><a href="#recommendations">Recommendations</a></li>
        </ol>
    </div>

    <div class="page-break"></div>

    <!-- Section 1: File System Architecture -->
    <h2 id="filesystem-arch">1. File System Architecture & Alternatives</h2>
    
    <p>The CSPro WASM environment requires a file system strategy that balances performance, persistence, and ease of use. Below are the three primary architectures available.</p>

    <h3>A. WASM Virtual File System (MEMFS/IDBFS) - <em>Current Default</em></h3>
    <p>Emscripten provides a virtual file system that exists within the browser's memory, optionally synced to IndexedDB for persistence.</p>
    <table>
        <tr>
            <th>Pros</th>
            <th>Cons</th>
        </tr>
        <tr>
            <td>
                <ul>
                    <li>Zero code change required for CSPro C++ engine.</li>
                    <li>Fast in-memory operations.</li>
                    <li>Standard POSIX compliance (fopen, fread work as expected).</li>
                </ul>
            </td>
            <td>
                <ul>
                    <li><strong>Memory Limit:</strong> Files consume RAM. Large dictionaries/data can crash the tab.</li>
                    <li><strong>Sync Overhead:</strong> Must explicitly sync to IndexedDB to save changes.</li>
                    <li><strong>Isolation:</strong> Cannot be easily accessed by other tabs or external tools.</li>
                </ul>
            </td>
        </tr>
    </table>

    <h3>B. Origin Private File System (OPFS) - <em>Recommended for Performance</em></h3>
    <p>The Origin Private File System provides a high-performance, file-based storage system private to the origin of the page.</p>
    <div class="web-api">
        <strong>Web API:</strong> <code>navigator.storage.getDirectory()</code><br>
        <strong>Emscripten Support:</strong> Available via <code>-lbfs.js</code> (WASMFS backend).
    </div>
    <table>
        <tr>
            <th>Pros</th>
            <th>Cons</th>
        </tr>
        <tr>
            <td>
                <ul>
                    <li><strong>High Performance:</strong> Optimized for random access (great for SQLite/CSPro DBs).</li>
                    <li><strong>Low Memory Footprint:</strong> Does not load entire files into RAM.</li>
                    <li><strong>Persistence:</strong> Native browser persistence without manual sync.</li>
                </ul>
            </td>
            <td>
                <ul>
                    <li>Requires newer browser versions (Chrome 86+, Safari 15.2+, Firefox 111+).</li>
                    <li>Requires Secure Context (HTTPS).</li>
                    <li>Data is opaque to the user (cannot easily "download" files without export).</li>
                </ul>
            </td>
        </tr>
    </table>
    <div class="code">
        <strong>Implementation Strategy:</strong> Mount OPFS to a specific mount point in WASM (e.g., <code>/data</code>) and configure CSPro to store cases/dictionaries there.
    </div>

    <h3>C. Server-Side Filesystem - <em>Recommended for Sync/Management</em></h3>
    <p>Files are stored on a remote server and accessed via API calls. The WASM client acts as a view/editor.</p>
    <table>
        <tr>
            <th>Pros</th>
            <th>Cons</th>
        </tr>
        <tr>
            <td>
                <ul>
                    <li><strong>Centralized Data:</strong> Immediate synchronization.</li>
                    <li><strong>Security:</strong> Data resides on server, not user device.</li>
                    <li><strong>Capacity:</strong> Limited only by server storage.</li>
                </ul>
            </td>
            <td>
                <ul>
                    <li><strong>Network Dependency:</strong> Requires constant internet connection (unless cached).</li>
                    <li><strong>Latency:</strong> Slower file operations due to network round-trips.</li>
                    <li><strong>Complexity:</strong> Requires implementing a Virtual File System (VFS) layer in C++ that proxies `fopen/fread` to HTTP requests.</li>
                </ul>
            </td>
        </tr>
    </table>

    <div class="page-break"></div>

    <!-- Section 2: Action Invoker API -->
    <h2 id="action-invoker">2. Action Invoker API Reference</h2>
    <p>The Action Invoker allows the web interface (JavaScript) to call CSPro functionality. Below is the complete reference of namespaces defined in <code>action-definitions.json</code>.</p>

    <h3>Namespace: Application</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Status</th></tr>
        <tr><td><span class="code">getFormFile</span></td><td>Returns form file object.</td><td><span class="status-implemented">Implemented</span></td></tr>
        <tr><td><span class="code">getQuestionnaireContent</span></td><td>Returns JSON content of questionnaire.</td><td><span class="status-implemented">Implemented</span></td></tr>
        <tr><td><span class="code">getQuestionText</span></td><td>Returns question text for item.</td><td><span class="status-implemented">Implemented</span></td></tr>
    </table>

    <h3>Namespace: Clipboard</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Web Implementation</th></tr>
        <tr><td><span class="code">getText</span></td><td>Get clipboard text.</td><td><code>navigator.clipboard.readText()</code></td></tr>
        <tr><td><span class="code">putText</span></td><td>Set clipboard text.</td><td><code>navigator.clipboard.writeText()</code></td></tr>
    </table>

    <h3>Namespace: Data</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Status</th></tr>
        <tr><td><span class="code">getCase</span></td><td>Returns case JSON data.</td><td><span class="status-implemented">Implemented</span></td></tr>
    </table>

    <h3>Namespace: Dictionary</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Status</th></tr>
        <tr><td><span class="code">getDictionary</span></td><td>Returns dictionary JSON structure.</td><td><span class="status-implemented">Implemented</span></td></tr>
    </table>

    <h3>Namespace: File</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Web Implementation</th></tr>
        <tr><td><span class="code">copy</span></td><td>Copy files.</td><td>Virtual FS / OPFS operation.</td></tr>
        <tr><td><span class="code">readBytes</span></td><td>Read file as binary/DataURL.</td><td><code>FileReader.readAsDataURL()</code></td></tr>
        <tr><td><span class="code">readText</span></td><td>Read file as string.</td><td><code>FileReader.readAsText()</code></td></tr>
        <tr><td><span class="code">writeText</span></td><td>Write string to file.</td><td>Virtual FS write.</td></tr>
        <tr><td><span class="code">writeBytes</span></td><td>Write binary to file.</td><td>Virtual FS write.</td></tr>
    </table>

    <h3>Namespace: Logic</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Status</th></tr>
        <tr><td><span class="code">eval</span></td><td>Run CSPro logic snippet.</td><td><span class="status-implemented">Implemented</span> (Calls WASM engine)</td></tr>
        <tr><td><span class="code">getSymbol</span></td><td>Get symbol value/metadata.</td><td><span class="status-implemented">Implemented</span></td></tr>
        <tr><td><span class="code">updateSymbolValue</span></td><td>Update symbol value.</td><td><span class="status-implemented">Implemented</span></td></tr>
        <tr><td><span class="code">invoke</span></td><td>Call user-defined function.</td><td><span class="status-implemented">Implemented</span></td></tr>
    </table>

    <h3>Namespace: Message</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Status</th></tr>
        <tr><td><span class="code">formatText</span></td><td>Format message string.</td><td><span class="status-implemented">Implemented</span></td></tr>
        <tr><td><span class="code">getText</span></td><td>Get message text by ID.</td><td><span class="status-implemented">Implemented</span></td></tr>
    </table>

    <h3>Namespace: Path</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Web Implementation</th></tr>
        <tr><td><span class="code">createDirectory</span></td><td>Create dir.</td><td>Virtual FS mkdir.</td></tr>
        <tr><td><span class="code">getDirectoryListing</span></td><td>List files.</td><td>Virtual FS readdir.</td></tr>
        <tr><td><span class="code">getPathInfo</span></td><td>Get file stats.</td><td>Virtual FS stat.</td></tr>
        <tr><td><span class="code">selectFile</span></td><td>Open file picker.</td><td><code>&lt;input type="file"&gt;</code> or File System Access API.</td></tr>
    </table>

    <h3>Namespace: Settings</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Web Implementation</th></tr>
        <tr><td><span class="code">getValue</span></td><td>Get setting.</td><td><code>localStorage.getItem()</code></td></tr>
        <tr><td><span class="code">putValue</span></td><td>Set setting.</td><td><code>localStorage.setItem()</code></td></tr>
    </table>

    <h3>Namespace: Sqlite</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Status</th></tr>
        <tr><td><span class="code">open/close/exec</span></td><td>SQLite operations.</td><td><span class="status-implemented">Implemented</span> (WASM SQLite)</td></tr>
    </table>

    <h3>Namespace: UI</h3>
    <table>
        <tr><th>Method</th><th>Description</th><th>Web Implementation</th></tr>
        <tr><td><span class="code">alert</span></td><td>Show alert.</td><td>HTML Dialog / <code>window.alert</code></td></tr>
        <tr><td><span class="code">showDialog</span></td><td>Show HTML dialog.</td><td><code>&lt;dialog&gt;</code> element or iframe.</td></tr>
        <tr><td><span class="code">view</span></td><td>View file/URL.</td><td><code>window.open()</code></td></tr>
    </table>

    <div class="page-break"></div>

    <!-- Section 3: Logic Functions -->
    <h2 id="logic-functions">3. Complete CSPro Logic Function Reference</h2>
    <p>This section lists all standard CSPro logic functions and their compatibility status in the WASM engine.</p>

    <h3>Numeric Functions</h3>
    <table>
        <tr>
            <td><span class="code">abs</span></td>
            <td><span class="code">exp</span></td>
            <td><span class="code">int</span></td>
            <td><span class="code">log</span></td>
            <td><span class="code">sqrt</span></td>
            <td><span class="code">round</span></td>
        </tr>
        <tr>
            <td><span class="code">random</span></td>
            <td><span class="code">seed</span></td>
            <td><span class="code">min</span></td>
            <td><span class="code">max</span></td>
            <td><span class="code">sum</span></td>
            <td><span class="code">average</span></td>
        </tr>
        <tr>
            <td><span class="code">count</span></td>
            <td><span class="code">inc</span></td>
            <td><span class="code">cmcode</span></td>
            <td><span class="code">special</span></td>
            <td><span class="code">visualvalue</span></td>
            <td><span class="code">tonumber</span></td>
        </tr>
    </table>
    <p class="status-implemented">Status: Fully Implemented (Native C++ Logic Engine)</p>

    <h3>String Functions</h3>
    <table>
        <tr>
            <td><span class="code">concat</span></td>
            <td><span class="code">strip</span></td>
            <td><span class="code">length</span></td>
            <td><span class="code">pos</span></td>
            <td><span class="code">poschar</span></td>
            <td><span class="code">replace</span></td>
        </tr>
        <tr>
            <td><span class="code">tolower</span></td>
            <td><span class="code">toupper</span></td>
            <td><span class="code">maketext</span></td>
            <td><span class="code">edit</span></td>
            <td><span class="code">sprintf</span></td>
            <td><span class="code">regexmatch</span></td>
        </tr>
    </table>
    <p class="status-implemented">Status: Fully Implemented (Native C++ Logic Engine)</p>

    <h3>Date/Time Functions</h3>
    <table>
        <tr>
            <td><span class="code">sysdate</span></td>
            <td><span class="code">systime</span></td>
            <td><span class="code">timestamp</span></td>
            <td><span class="code">datediff</span></td>
            <td><span class="code">dateadd</span></td>
            <td><span class="code">datevalid</span></td>
        </tr>
    </table>
    <p class="status-implemented">Status: Fully Implemented (Uses browser clock)</p>

    <h3>File & Dictionary Functions</h3>
    <table>
        <tr>
            <td><span class="code">loadcase</span></td>
            <td><span class="code">writecase</span></td>
            <td><span class="code">delcase</span></td>
            <td><span class="code">find</span></td>
            <td><span class="code">key</span></td>
            <td><span class="code">open</span></td>
        </tr>
        <tr>
            <td><span class="code">close</span></td>
            <td><span class="code">filewrite</span></td>
            <td><span class="code">fileread</span></td>
            <td><span class="code">fileexist</span></td>
            <td><span class="code">filedelete</span></td>
            <td><span class="code">filecopy</span></td>
        </tr>
    </table>
    <p class="status-implemented">Status: Implemented (Uses Virtual File System)</p>

    <h3>Control & Data Entry Functions</h3>
    <table>
        <tr>
            <td><span class="code">skip</span></td>
            <td><span class="code">advance</span></td>
            <td><span class="code">reenter</span></td>
            <td><span class="code">noinput</span></td>
            <td><span class="code">endgroup</span></td>
            <td><span class="code">endlevel</span></td>
        </tr>
        <tr>
            <td><span class="code">curocc</span></td>
            <td><span class="code">totocc</span></td>
            <td><span class="code">maxocc</span></td>
            <td><span class="code">soccurs</span></td>
            <td><span class="code">noccurs</span></td>
            <td><span class="code">insert</span></td>
        </tr>
    </table>
    <p class="status-implemented">Status: Fully Implemented (Core Engine Logic)</p>

    <div class="page-break"></div>

    <!-- Section 4: OS-Specific Deep Dive -->
    <h2 id="os-specific">4. OS-Specific Function Deep Dive</h2>
    <p>These functions require specific Web API integrations as they interact with hardware or OS features.</p>

    <h3>System/Device Information</h3>
    <table>
        <tr><th>Function</th><th>Status</th><th>Web API Alternative</th></tr>
        <tr><td><span class="code">getos()</span></td><td><span class="status-partial">Partial</span></td><td><code>navigator.userAgent</code> / <code>navigator.platform</code></td></tr>
        <tr><td><span class="code">getdeviceid()</span></td><td><span class="status-stub">Stub</span></td><td><code>localStorage</code> + <code>crypto.randomUUID()</code></td></tr>
        <tr><td><span class="code">getusername()</span></td><td><span class="status-stub">Stub</span></td><td>Custom Auth System</td></tr>
        <tr><td><span class="code">connection()</span></td><td><span class="status-stub">Stub</span></td><td><code>navigator.onLine</code></td></tr>
    </table>

    <h3>GPS/Geolocation</h3>
    <table>
        <tr><th>Function</th><th>Status</th><th>Web API Alternative</th></tr>
        <tr><td><span class="code">gps(open/read)</span></td><td><span class="status-stub">Stub</span></td><td><code>navigator.geolocation.getCurrentPosition()</code></td></tr>
    </table>

    <h3>Multimedia (Audio/Camera)</h3>
    <table>
        <tr><th>Function</th><th>Status</th><th>Web API Alternative</th></tr>
        <tr><td><span class="code">audio(record)</span></td><td><span class="status-stub">Stub</span></td><td><code>MediaRecorder API</code></td></tr>
        <tr><td><span class="code">audio(play)</span></td><td><span class="status-stub">Stub</span></td><td><code>HTMLAudioElement</code></td></tr>
        <tr><td><span class="code">image(camera)</span></td><td><span class="status-stub">Stub</span></td><td><code>navigator.mediaDevices.getUserMedia()</code></td></tr>
        <tr><td><span class="code">barcode(read)</span></td><td><span class="status-stub">Stub</span></td><td><code>BarcodeDetector API</code> / QuaggaJS</td></tr>
    </table>

    <h3>Network/Sync</h3>
    <table>
        <tr><th>Function</th><th>Status</th><th>Web API Alternative</th></tr>
        <tr><td><span class="code">syncconnect</span></td><td><span class="status-partial">Partial</span></td><td><code>fetch()</code> API (HTTP/HTTPS only)</td></tr>
        <tr><td><span class="code">syncdata</span></td><td><span class="status-partial">Partial</span></td><td><code>fetch()</code> with JSON payload</td></tr>
        <tr><td><span class="code">Bluetooth</span></td><td><span class="status-unavailable">N/A</span></td><td>Not supported (Use HTTP Sync)</td></tr>
    </table>

    <h3>External Execution</h3>
    <table>
        <tr><th>Function</th><th>Status</th><th>Web API Alternative</th></tr>
        <tr><td><span class="code">execsystem</span></td><td><span class="status-unavailable">N/A</span></td><td>Blocked by browser security.</td></tr>
        <tr><td><span class="code">execpff</span></td><td><span class="status-unavailable">N/A</span></td><td>Blocked by browser security.</td></tr>
    </table>

    <div class="page-break"></div>

    <h2 id="recommendations">5. Recommendations</h2>
    
    <ol>
        <li>
            <strong>Adopt OPFS for Storage:</strong> 
            Migrate from the default MEMFS to Origin Private File System (OPFS) for storing cases and dictionaries. This ensures data persistence across sessions and handles larger datasets without crashing the browser tab.
        </li>
        <li>
            <strong>Implement JSPI Bridges:</strong>
            Prioritize implementing the "Stub" functions for GPS, Camera, and Barcode using the JSPI (JavaScript Promise Integration) pattern. This unlocks critical data collection features.
        </li>
        <li>
            <strong>Replace Sync Logic:</strong>
            Instead of relying on CSPro's internal `syncconnect` logic (which may expect raw sockets or FTP), implement a JavaScript-based sync manager that uses the standard `fetch` API to communicate with CSWeb, and expose it to CSPro via the Action Invoker.
        </li>
        <li>
            <strong>Security Review:</strong>
            Ensure all Web APIs (Geolocation, Camera) are used in a Secure Context (HTTPS), as modern browsers block these features on HTTP.
        </li>
    </ol>

    <hr style="margin-top: 40px;">
    
    <footer style="text-align: center; color: #666; margin-top: 20px;">
        <p>CSPro WASM/Web Logic & API Implementation Report</p>
        <p>Generated for CSEntry Web Application Project</p>
        <p>Â© 2025 - Document Version 2.0 (Expanded)</p>
    </footer>
</body>
</html>
